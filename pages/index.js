import Head from 'next/head';
import Image from 'next/image';
import { useEffect, useState } from 'react';
// const ws = require('ws');

export default function Home() {
    const [currencies, setCurrencies] = useState([]);

    useEffect(() => {
        let pairs = ['tBTCUSD', 'tBTCEUR', 'tETHUSD', 'tETHEUR', 'tEOSUSD'];
        let connections = [];

        pairs.forEach((pair) => {
            let wss = new WebSocket('wss://api-pub.bitfinex.com/ws/2');
            connections.push(wss);
            let msg = JSON.stringify({
                event: 'subscribe',
                channel: 'ticker',
                symbol: pair,
            });

            wss.onmessage = (msg) => {
                let response = JSON.parse(msg.data);
                console.log(response);
                if (response.event === 'info') {
                    return;
                }
                if (response.event === 'subscribed') {
                    setCurrencies((currencies) => [
                        ...currencies,
                        { symbol: response.symbol, chanId: response.chanId },
                    ]);
                } else {
                    // setCurrencies(
                    //     [...currencies].map((curr) => {
                    //         if (curr.chanId === response[0]) {
                    //         }
                    //     })
                    // );
                }
            };

            wss.onopen = () => {
                wss.send(msg);
            };
        });
        return () => {
            for (let i = 0; i < connections.length; i++) {
                connections[i].close();
            }
        };
    }, []);
    return (
        <div>
            <Head>
                <title>TeleTrader</title>
                <meta
                    name="description"
                    content="Generated by create next app"
                />
                <link rel="icon" href="/favicon.ico" />
            </Head>
            <pre>{JSON.stringify(currencies)}</pre>
        </div>
    );
}
